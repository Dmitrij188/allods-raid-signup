<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Рейды Аллоды Онлайн</title>
  <style>
    @font-face {
      font-family: 'Allods West';
      src: url('allods_west.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }

    body {
      background-image: url("1931c04e9200fc1f4ef619ec953247d86ddcb0fe.jpg");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      color: #fff;
      font-family: 'Allods West', Arial, sans-serif;
      padding: 20px;
    }
    h1, h2 {
      color: #ffc107;
    }
    .raid-container {
      margin-bottom: 40px;
      padding: 20px;
      background-color: rgba(46, 46, 78, 0.85);
      border-radius: 10px;
    }
    .form-section {
      margin-bottom: 20px;
    }
    label, select, input {
      display: block;
      margin: 8px 0;
    }
    .raid-roster {
      margin-top: 20px;
    }
    .slot {
      padding: 10px;
      margin: 5px;
      border-radius: 6px;
      background-color: #3a3a5c;
    }
    .btn {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    .btn-admin {
      background-color: #007bff;
      margin-top: 10px;
    }
    .music-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #6f42c1;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
    .class-icon {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h1>Рейды Аллоды Онлайн</h1>
  <button class="music-toggle" onclick="toggleMusic()" id="musicBtn">Выключить музыку</button>

  <div id="raids"></div>
  <button class="btn btn-admin" onclick="createRaid()">+ Создать новый рейд</button>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwFICJTn66YG-pJgo2OdkCVbYQzH_bbR4poFfoROUBIkQgZAhXeXpcSETK0yh6cSL3k/exec';

    const musicBtn = document.getElementById("musicBtn");
    const musicTracks = [
      new Audio("23 - IL1_TEST.mp3"),
      new Audio("27 - MenuAmbient.mp3"),
      new Audio("5fc0f02753de4.mp3"),
      new Audio("5fc0f2c121559.mp3")
    ];
    let currentTrack = 0;

musicTracks.forEach((track, index) => {
  track.volume = 0.5;
  track.loop = false;
  track.addEventListener("ended", () => {
    currentTrack = (currentTrack + 1) % musicTracks.length;
    musicTracks[currentTrack].play();
  });
});

musicTracks[currentTrack].play();

    function toggleMusic() {
      if (musicTracks[currentTrack].paused) {
        musicTracks[currentTrack].play();
        musicBtn.textContent = "Выключить музыку";
      } else {
        musicTracks.forEach(track => track.pause());
        musicBtn.textContent = "Включить музыку";
      }
    }

    const MAX_RAIDS = 4;
    const MAX_PLAYERS = 12;
    let raids = [];

    const classes = ["Жрец", "Воин", "Паладин", "Лучник", "Мистик", "Друид", "Демонолог", "Инженер", "Некромант", "Маг", "Бард"];
    const roles = ["ДД", "Хил", "Сап", "Танк"];

    const classIcons = {
      "Жрец": "jrec.png",
      "Воин": "AaXElGEQ.png",
      "Паладин": "paladin.png",
      "Лучник": "luchnik.png",
      "Мистик": "mistik.png",
      "Друид": "druid.png",
      "Демонолог": "nekromant.png",
      "Инженер": "inginer.png",
      "Некромант": "nekromant.png",
      "Маг": "mag.png",
      "Бард": "bard.png"
    };

    async function loadRoster() {
      const res = await fetch(scriptURL);
      const data = await res.json();
      const grouped = {};
      data.forEach(row => {
        const [name, className, role, role2, role3, raidId] = row;
        if (!grouped[raidId]) grouped[raidId] = [];
        grouped[raidId].push({ name, className, role, role2, role3 });
      });

      raids = Object.keys(grouped).map(id => ({ id, roster: grouped[id] }));
      renderRaids();
    }

    function createRaid() {
      if (raids.length >= MAX_RAIDS) return alert("Максимум 4 рейда");
      const raidId = raids.length;
      const raid = {
        id: raidId,
        roster: []
      };
      raids.push(raid);
      renderRaids();
    }

    function renderRaids() {
      const raidsDiv = document.getElementById("raids");
      raidsDiv.innerHTML = "";
      raids.forEach((raid, index) => {
        const raidEl = document.createElement("div");
        raidEl.className = "raid-container";
        raidEl.innerHTML = `
          <h2>Рейд ${+raid.id + 1}</h2>
          <div class="form-section">
            <label>Имя: <input type="text" id="name-${raid.id}"></label>
            <label>Класс:
              <select id="class-${raid.id}">
                ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
              </select>
            </label>
            <label>Основная роль:
              <select id="role-${raid.id}">
                ${roles.map(r => `<option>${r}</option>`).join('')}
              </select>
            </label>
            <label>Доп. роль:
              <select id="role2-${raid.id}">
                <option value="">—</option>
                ${roles.map(r => `<option>${r}</option>`).join('')}
              </select>
            </label>
            <label>Доп. роль (крайний случай):
              <select id="role3-${raid.id}">
                <option value="">—</option>
                ${roles.map(r => `<option>${r}</option>`).join('')}
              </select>
            </label>
            <button class="btn" onclick="joinRaid(${raid.id})">Записаться</button>
          </div>
          <div class="raid-roster" id="roster-${raid.id}">
            <h3>Состав:</h3>
            ${renderRoster(raid)}
          </div>
        `;
        raidsDiv.appendChild(raidEl);
      });
    }

    function renderRoster(raid) {
      if (!raid.roster.length) return '<p>Пока никто не записался.</p>';
      return raid.roster.map(p => {
        const icon = classIcons[p.className] ? `<img class='class-icon' src="${classIcons[p.className]}" alt="${p.className}">` : "";
        return `<div class='slot'>${icon}${p.name} — ${p.className} (осн: ${p.role}, доп: ${p.role2 || '-'}, крайний случай: ${p.role3 || '-'})</div>`;
      }).join('');
    }

    async function joinRaid(id) {
      const name = document.getElementById(`name-${id}`).value.trim();
      const className = document.getElementById(`class-${id}`).value;
      const role = document.getElementById(`role-${id}`).value;
      const role2 = document.getElementById(`role2-${id}`).value;
      const role3 = document.getElementById(`role3-${id}`).value;

      if (!name) return alert("Введите имя!");

      const currentRaid = raids.find(r => +r.id === +id);
      if (!currentRaid) return alert("Рейд не найден!");

      if (currentRaid.roster.length >= MAX_PLAYERS) {
        return alert("Этот рейд уже заполнен (12 игроков).");
      }

      const duplicate = currentRaid.roster.some(p => p.name.toLowerCase() === name.toLowerCase());
      if (duplicate) {
        return alert("Вы уже записаны в этот рейд.");
      }

      const payload = {
        name, className, role, role2, role3, raidId: id
      };

      await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      await loadRoster();
    }

    loadRoster();
  </script>
</body>
</html>
